<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard — Exemple Bootstrap 5.3</title>
    <meta name="description" content="Base HTML avec Bootstrap 5.3" />
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1055;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <div class="rounded me-2" style="width: 20px; height: 20px;" id="toastIcon"></div>
                <strong class="me-auto" id="toastTitle"><!-- Titre ici --></strong>
                <small id="toastTime"><!-- Le moment ici --></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fermer"></button>
            </div>
            <div class="toast-body" id="toastMessage"> <!-- Le Message sera ICI --> </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Guardian Supervision</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Basculer la navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMain">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="configuration.html">Configuration</a></li>
                    <li class="nav-item"><a class="nav-link" href="compte.html">Compte</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-5">
        <h1 class="mb-4">Configuration</h1>
        <div class="row">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">Informations de l'équipement</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="hostName" class="form-label">Nom de l'équipement</label>
                            <input type="text" class="form-control" id="hostName" required>
                        </div>
                        <div class="mb-3">
                            <label for="hostIP" class="form-label">Adresse IP</label>
                            <input type="text" class="form-control" id="hostIP" required>
                        </div>
                        <button onclick="updateHost()" class="btn btn-primary">Enregistrer les modifications</button>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header">Informations SSH</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="sshUsername" class="form-label">Nom d'utilisateur SSH</label>
                            <input type="text" class="form-control" id="sshUsername">
                        </div>
                        <div class="mb-3">  
                            <label for="sshPassword" class="form-label">Mot de passe SSH</label>
                            <input type="password" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="sshPort" class="form-label">Port SSH</label>
                            <input type="number" class="form-control" id="sshPort" value="22">
                        </div>
                        <button onclick="updateSSHHost()" class="btn btn-primary">Enregistrer les modifications</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Intitulé</th>
                            <th>Action</th>
                            <th>Intervalle</th>
                        </tr>
                    </thead>
                    <tbody id="tableIndicatorsBody">
                        <!-- Les lignes des indicateurs seront insérées ici dynamiquement -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td><button class="btn btn-outline-primary" onclick="addIndicator()">+</button></td>
                            <td><input type="text" class="form-control" placeholder="Intitulé"></td>
                            <td>
                                <select class="form-select" id="ActionSelector">
                                    <option value="">Sélectionner une action</option>
                                    <!-- Les options des actions seront insérées ici dynamiquement -->
                                </select>
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="Intervalle">
                                    <span class="input-group-text">s</span>
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4">
        <div class="container text-center">
            <small>&copy; 2025 Guardian Supervision — Tous droits réservés</small>
        </div>
    </footer>

    <!-- Bootstrap Bundle JS (Popper inclus) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="toaster.js"></script>
    <script>
        async function getHost() { 
            params = new URLSearchParams(window.location.search);
            id = params.get('id');
            if (id) {
                url = `http://127.0.0.1:8000/host/${encodeURIComponent(id)}`;
            } else {
                console.error("ID de l'hôte manquant dans les paramètres URL.");
                return;
            }
            
            try {
                response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Impossible de récupérer les hôtes:", error);
                return [];
            }
        }

        async function getIndicators(hostId) {
            url = `http://127.0.0.1:8000/host/${hostId}/indicators`;
            try {
                response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Impossible de récupérer les indicateurs pour l'hôte ${hostId}:`, error);
                return [];
            }
        }

        async function getActions() {
            url = `http://127.0.0.1:8000/actions`;
            try {
                response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Impossible de récupérer les actions:", error);
                return [];
            }
        }

        (async () => {
            host = await getHost();
            if (!host) return;
            document.getElementById('hostName').value = host.name;
            document.getElementById('hostIP').value = host.ip;
            document.getElementById('sshUsername').value = host.username || '';
            document.getElementById('sshPort').value = host.ssh_port || 22

            indicators = await getIndicators(host.id);
            tableBody = document.getElementById('tableIndicatorsBody');
            for (indicator of indicators) {
                row = document.createElement('tr');
                row.innerHTML = `
                    <td>${indicator.id}</td>
                    <td>${indicator.name}</td>
                    <td>${indicator.action_id || 'N/A'}</td>
                    <td>${indicator.interval}</td>
                `;
                tableBody.appendChild(row);
            }
        })();

        async function updateHost() {
            params = new URLSearchParams(window.location.search);
            id = params.get('id');
            if (id) { url = `http://127.0.0.1:8000/host/${encodeURIComponent(id)}`;
            } else { 
                showToast('Erreur', 'ID de l\'hôte manquant dans l\'URL', 'error');
                return; 
            }
            data = {
                name: document.getElementById('hostName').value,
                ip: document.getElementById('hostIP').value,
            };
            try {
                response = await fetch(url, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json',},
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                }
                const result = await response.json();
                showToast('Succès', 'Hôte mis à jour avec succès', 'success');
                return result;
            } catch (error) {
                console.error(`Impossible de mettre à jour l'hôte ${id}:`, error);
                showToast('Erreur', 'Impossible de mettre à jour l\'hôte', 'error');
                return null;
            }
        }

        async function populateActions() {
            const actions = await getActions();
            const actionSelector = document.getElementById('ActionSelector');
            actions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.id;
                option.textContent = action.name;
                actionSelector.appendChild(option);
            });
        }
        populateActions();

        async function updateSSHHost() {
            showToast('Information', 'Fonction SSH en cours de développement', 'warning');
        }
        async function addIndicator() {
            showToast('Information', 'Fonction d\'ajout d\'indicateur en cours de développement', 'warning');
        }

    </script>
</body>
</html>